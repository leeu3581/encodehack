function e(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function n(e,n,t,s,r,i,a){try{var o=e[i](a);var c=o.value}catch(e){t(e);return}if(o.done){n(c)}else{Promise.resolve(c).then(s,r)}}function t(e){return function(){var t=this,s=arguments;return new Promise(function(r,i){var a=e.apply(t,s);function o(e){n(a,r,i,o,c,"next",e)}function c(e){n(a,r,i,o,c,"throw",e)}o(undefined)})}}function s(e,n){if(!(e instanceof n)){throw new TypeError("Cannot call a class as a function")}}function r(e,n){for(var t=0;t<n.length;t++){var s=n[t];s.enumerable=s.enumerable||false;s.configurable=true;if("value"in s)s.writable=true;Object.defineProperty(e,s.key,s)}}function i(e,n,t){if(n)r(e.prototype,n);if(t)r(e,t);return e}function a(e){a=Object.setPrototypeOf?Object.getPrototypeOf:function e(e){return e.__proto__||Object.getPrototypeOf(e)};return a(e)}function o(e,n){if(typeof n!=="function"&&n!==null){throw new TypeError("Super expression must either be null or a function")}e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:true,configurable:true}});if(n)h(e,n)}function c(e,n){if(n!=null&&typeof Symbol!=="undefined"&&n[Symbol.hasInstance]){return!!n[Symbol.hasInstance](e)}else{return e instanceof n}}function u(n,t){if(t&&(l(t)==="object"||typeof t==="function")){return t}return e(n)}function h(e,n){h=Object.setPrototypeOf||function e(e,n){e.__proto__=n;return e};return h(e,n)}function l(e){"@swc/helpers - typeof";return e&&typeof Symbol!=="undefined"&&e.constructor===Symbol?"symbol":typeof e}function d(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true}catch(e){return false}}function f(e){var n=d();return function t(){var t=a(e),s;if(n){var r=a(this).constructor;s=Reflect.construct(t,arguments,r)}else{s=t.apply(this,arguments)}return u(this,s)}}function p(e,n){var t,s,r,i,a={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]};return i={next:o(0),"throw":o(1),"return":o(2)},typeof Symbol==="function"&&(i[Symbol.iterator]=function(){return this}),i;function o(e){return function(n){return c([e,n])}}function c(i){if(t)throw new TypeError("Generator is already executing.");while(a)try{if(t=1,s&&(r=i[0]&2?s["return"]:i[0]?s["throw"]||((r=s["return"])&&r.call(s),0):s.next)&&!(r=r.call(s,i[1])).done)return r;if(s=0,r)i=[i[0]&2,r.value];switch(i[0]){case 0:case 1:r=i;break;case 4:a.label++;return{value:i[1],done:false};case 5:a.label++;s=i[1];i=[0];continue;case 7:i=a.ops.pop();a.trys.pop();continue;default:if(!(r=a.trys,r=r.length>0&&r[r.length-1])&&(i[0]===6||i[0]===2)){a=0;continue}if(i[0]===3&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(i[0]===6&&a.label<r[1]){a.label=r[1];r=i;break}if(r&&a.label<r[2]){a.label=r[2];a.ops.push(i);break}if(r[2])a.ops.pop();a.trys.pop();continue}i=n.call(e,a)}catch(e){i=[6,e];s=0}finally{t=r=0}if(i[0]&5)throw i[1];return{value:i[0]?i[1]:void 0,done:true}}}var y=Object.defineProperty;var v=function(e,n,t){return n in e?y(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t};var _=function(e,n,t){return v(e,(typeof n==="undefined"?"undefined":l(n))!="symbol"?n+"":n,t),t};import m from"@binance/w3w-qrcode-modal";import{SocketTransport as I}from"@binance/w3w-socket-transport";import{DisconnectType as g}from"@binance/w3w-types";import{log as k,uuid as b,encrypt as w,decrypt as S,MISC_ERR as R,RPC_ERROR as E,payloadId as T,generateKey as C,signingMethods as O,CONNECTION_ERR as N,ProviderRpcError as M,getClientMetadata as A,convertNumberToHex as P,openBinanceDeepLink as D,formatJsonRpcRequest as x}from"@binance/w3w-utils";import{Events as j,convertHexToArrayBuffer as L,convertArrayBufferToHex as q,getStorage as J,removeStorage as B,setStorage as G,uuid as H}from"@binance/w3w-utils";var Q="connect-session",U="connect-domains",V="connect-domains-configs",F="wss://nbstream.binance.com/wallet-connector",K=["https://rpc.ankr.com/bsc","https://binance.nodereal.io","https://bscrpc.com","https://bsc-dataseed2.ninicoin.io"];var W=function(n){"use strict";o(r,n);var t=f(r);function r(){s(this,r);var n;n=t.call.apply(t,[this].concat(Array.prototype.slice.call(arguments)));_(e(n),"pending",!1);_(e(n),"callbacks",new Map);_(e(n),"clientMeta");_(e(n),"relay");_(e(n),"_key",null);_(e(n),"_clientId","");_(e(n),"_peerId","");_(e(n),"_peerMeta",null);_(e(n),"_handshakeId",0);_(e(n),"_handshakeTopic","");_(e(n),"_connected",!1);_(e(n),"_accounts",[]);_(e(n),"_chainId","0x0");return n}i(r,[{key:"key",get:function e(){return this._key?q(this._key,!0):""},set:function e(e){if(!e)return;var n=L(e);this._key=n}},{key:"clientId",get:function e(){var e=this._clientId;return e||(e=this._clientId=H()),this._clientId},set:function e(e){e&&(this._clientId=e)}},{key:"peerId",get:function e(){return this._peerId},set:function e(e){e&&(this._peerId=e)}},{key:"peerMeta",get:function e(){return this._peerMeta},set:function e(e){this._peerMeta=e}},{key:"handshakeTopic",get:function e(){return this._handshakeTopic},set:function e(e){e&&(this._handshakeTopic=e)}},{key:"handshakeId",get:function e(){return this._handshakeId},set:function e(e){e&&(this._handshakeId=e)}},{key:"uri",get:function e(){return"wc:".concat(this.handshakeTopic,"@1?bridge=").concat(this.relay,"&key=").concat(this.key,"&scene=bid")}},{key:"chainId",get:function e(){return this._chainId},set:function e(e){this._chainId=e}},{key:"accounts",get:function e(){return this._accounts},set:function e(e){this._accounts=e}},{key:"connected",get:function e(){return this._connected},set:function e(e){}},{key:"session",get:function e(){return{connected:this.connected,accounts:this.accounts,chainId:this.chainId,relay:this.relay,key:this.key,clientId:this.clientId,clientMeta:this.clientMeta,peerId:this.peerId,peerMeta:this.peerMeta,handshakeId:this.handshakeId,handshakeTopic:this.handshakeTopic}},set:function e(e){e&&(this._connected=e.connected,this.accounts=e.accounts,this.chainId=e.chainId,this.relay=e.relay,this.key=e.key,this.clientId=e.clientId,this.clientMeta=e.clientMeta,this.peerId=e.peerId,this.peerMeta=e.peerMeta,this.handshakeId=e.handshakeId,this.handshakeTopic=e.handshakeTopic)}}]);return r}(j),Y=function(e){"use strict";o(t,e);var n=f(t);function t(){s(this,t);return n.apply(this,arguments)}i(t,[{key:"getStorageSession",value:function e(){try{return J(Q)}catch(e){}return null}},{key:"setStorageSession",value:function e(){G(Q,this.session)}},{key:"removeStorageSession",value:function e(){B(Q)}},{key:"manageStorageSession",value:function e(){this._connected?this.setStorageSession():this.removeStorageSession()}}]);return t}(W);import{detectWebSocket as z}from"@binance/w3w-socket-transport";import{isNode as X,setStorage as Z,getStorage as $,removeStorage as ee}from"@binance/w3w-utils";import{Interface as en}from"@ethersproject/abi";import et from"axios";import{decode as es}from"js-base64";var er=null;function ei(){return ea.apply(this,arguments)}function ea(){ea=t(function(){var e,n,t;return p(this,function(s){switch(s.label){case 0:return[4,Promise.any(K.map(function(e){return et.request({url:e,method:"POST",data:{jsonrpc:"2.0",id:Date.now(),method:"eth_call",params:[{to:"0x76054B318785b588A3164B2A6eA5476F7cBA51e0",data:"0x97b5f450"},"latest"]}})}))];case 1:e=s.sent(),n=new en(["function apiDomains() view returns (string)"]),t=es(n.decodeFunctionResult("apiDomains",e.data.result)[0]).split(",");return[2,(Z(V,t),console.log("\uD83D\uDE80 ~ file: relay.ts ~ .then ~ domains configs:",t),t)]}})});return ea.apply(this,arguments)}function eo(e){return e.filter(function(e){return e.ttl>0}).sort(function(e,n){return e.ttl-n.ttl}).map(function(e){return e.url})}function ec(){return eu.apply(this,arguments)}function eu(){eu=t(function(){var e,n,t,s;return p(this,function(r){switch(r.label){case 0:e=$(V);if(!((e===null||e===void 0?void 0:e.length)>0))return[3,1];s=e;return[3,3];case 1:return[4,er];case 2:s=r.sent();r.label=3;case 3:n=s;return[4,Promise.all(n.map(function(e){var n=e.split(".").slice(1).join(".");return z("wss://nbstream.".concat(n,"/wallet-connector"))}))];case 4:t=r.sent();return[2,eo(t)]}})});return eu.apply(this,arguments)}function eh(e){return el.apply(this,arguments)}function el(){el=t(function(e){var n;return p(this,function(t){switch(t.label){case 0:return[4,Promise.all(e===null||e===void 0?void 0:e.map(function(e){return z(e)}))];case 1:n=t.sent();return[2,eo(n||[])]}})});return el.apply(this,arguments)}var ed=null;function ef(){return ep.apply(this,arguments)}function ep(){ep=t(function(){var e,n,t,s,r;return p(this,function(i){switch(i.label){case 0:e=$(U);i.label=1;case 1:i.trys.push([1,9,,10]);n=[];if(!(!e||e.length===0))return[3,3];return[4,ec()];case 2:n=i.sent();return[3,8];case 3:t=e[0];return[4,eh([t])];case 4:if(!(i.sent().length===0))return[3,6];return[4,ec()];case 5:s=n=i.sent();return[3,7];case 6:s=n=e;i.label=7;case 7:s;i.label=8;case 8:return[2,(console.log("\uD83D\uDE80 ~ file: relay.ts ~ .then ~ domains:",n),Z(U,n),n)];case 9:r=i.sent();return[2,[]];case 10:return[2]}})});return ep.apply(this,arguments)}X()||(er=ei(),ed=ef());function ey(){return ev.apply(this,arguments)}function ev(){ev=t(function(){var e;return p(this,function(n){switch(n.label){case 0:return[4,ed||ef()];case 1:e=n.sent();return[2,(ed=null,e.length===0&&e.push(F),e)]}})});return ev.apply(this,arguments)}function e_(e){var n=$(U);if(!n)return;var t=n.filter(function(n){return n!==e});Z(U,t)}function em(){ee(U)}import{ProviderRpcError as eI,RPC_ERROR as eg,MISC_ERR as ek}from"@binance/w3w-utils";function eb(e){return e.code===-32050||e.code===-32e3||e.code===1e3?new eI(eg.REJECT_ERR.code,eg.REJECT_ERR.message):e.code===-32603?new eI(ek.INTERNAL_ERR.code,ek.INTERNAL_ERR.message):e.code===-32600||e.code===-32602?new eI(eg.INVALID_PARAM.code,eg.INVALID_PARAM.message):e}function ew(e){var n=e.indexOf("?");return n>-1?e.slice(0,n):e}var eS=function(n){"use strict";o(a,n);var r=f(a);function a(){s(this,a);var n;n=r.call(this);_(e(n),"transport");_(e(n),"lng");n.clientMeta=A();var t=n.getStorageSession();t&&(n.session=t),n.handshakeId&&n.subscribeToSessionResponse(n.handshakeId),n.initTransport(),n.subscribeInternalEvent();return n}i(a,[{key:"request",value:function e(e){var n=this;return t(function(){return p(this,function(t){if(!n.connected)throw new M(N.PROVIDER_NOT_READY.code,N.PROVIDER_NOT_READY.message);if(O.indexOf(e.method)<0)throw new M(E.METHOD_NOT_SUPPORT.code,E.METHOD_NOT_SUPPORT.message);switch(e.method){case"eth_requestAccounts":return[2,n.accounts];case"eth_accounts":return[2,n.accounts];case"eth_chainId":return[2,P(n.chainId)];case"eth_signTransaction":case"eth_sendTransaction":case"eth_sign":case"personal_sign":case"eth_signTypedData":case"eth_signTypedData_v1":case"eth_signTypedData_v2":case"eth_signTypedData_v3":case"eth_signTypedData_v4":case"wallet_switchEthereumChain":case"wallet_watchAsset":return[2,new Promise(function(t,s){e.id||(e.id=T()),n.callbacks.set("response-".concat(e.id),function(e,n){e?s(eb(e)):n?t(n.result):s(new M(E.MISSING_RESPONSE.code,E.MISSING_RESPONSE.message))}),n.sendRequest(e),n.events.emit("call_request_sent")})];default:break}return[2]})})()}},{key:"killSession",value:function e(){if(!this.connected)return;var e={approved:!1,chainId:null,networkId:null,accounts:null},n={id:T(),method:"wc_sessionUpdate",params:[e]};this.sendRequest(n),this.handleSessionDisconnect(g.DisconnectAtClient)}},{key:"connect",value:function e(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},n=e.chainId,s=e.lng,r=e.showQrCodeModal;var i=this;return t(function(){return p(this,function(e){return[2,(i.lng=s,i.connected?{chainId:i.chainId,accounts:i.accounts}:new Promise(function(e,t){i.on("modal_closed",function(e){t(e)}),i.on("session_error",function(e){t(e)}),i.on("connect",function(n){e(n)}),i.createSession({chainId:n,showQrCodeModal:r})}))]})})()}},{key:"createSession",value:function e(e){var n=e.chainId,t=e.showQrCodeModal;try{if(this.connected)throw new M(N.CONNECTED.code,N.CONNECTED.message);if(this.pending||this._handshakeTopic)throw new M(N.CONNECTING.code,N.CONNECTING.message);this.pending=!0,this._key=C(),this.handshakeId=T(),this.handshakeTopic=b();var s={id:this.handshakeId,method:"wc_sessionRequest",params:[{peerId:this.clientId,peerMeta:this.clientMeta,chainId:n?Number(n):null}]};this.sendRequest(s,this.handshakeTopic),this.subscribeToSessionResponse(this.handshakeId),this.events.emit("display_uri",{showQrCodeModal:t})}catch(e){this.pending=!1;var r="response-".concat(this.handshakeId);this.callbacks.get(r)&&this.callbacks.delete(r);var i=e.message,a=c(e,M)?e:new M(R.INTERNAL_ERR.code,"".concat(R.INTERNAL_ERR.message,": ").concat(i));throw this.handleRejectSessionConnection(a),k.error("[binance-w3w] create connection failed: ".concat(i)),a}}},{key:"initTransport",value:function e(){var e=this;return t(function(){var n,t,s,r;return p(this,function(i){switch(i.label){case 0:e.transport=new I({version:1,subscriptions:[e.clientId]}),e.transport.on("message",function(n){return e.setIncomingMessages(n)}),e.transport.on("open",function(n){e.events.emit("transport_open",n)}),e.transport.on("close",function(){e.events.emit("transport_close")}),e.transport.on("error",function(n,t){e.events.emit("transport_error",n,t)});i.label=1;case 1:i.trys.push([1,5,,6]);if(!e.session.relay)return[3,2];e.transport.open([e.session.relay]);return[3,4];case 2:return[4,ey()];case 3:n=i.sent();e.transport.open(n);i.label=4;case 4:return[3,6];case 5:t=i.sent();em();s=t.message,r=new M(R.INTERNAL_ERR.code,"".concat(R.INTERNAL_ERR.message,": ").concat(s));throw e.handleRejectSessionConnection(r),r;case 6:return[2]}})})()}},{key:"setIncomingMessages",value:function e(e){if(![this.clientId,this.handshakeTopic].includes(e.topic))return;var n;try{n=JSON.parse(e.payload)}catch(e){return}var t=this.decrypt(n);if(!t)return;if("method"in t&&t.method){this.events.emit(t.method,null,t);return}var s=t.id,r="response-".concat(s),i=this.callbacks.get(r);if(i){if("error"in t&&t.error){var a=new M(t.error.code,t.error.message);i(a,null)}else"result"in t&&t.result&&i(null,t);this.callbacks.delete(r)}else k.error("[binance-w3w] callback id: ".concat(s," not found"))}},{key:"encrypt",value:function e(e){var n=this._key;return n?w(e,n):null}},{key:"decrypt",value:function e(e){var n=this._key;return n?S(e,n):null}},{key:"sendRequest",value:function e(e,n){var t=x(e.method,e.params,e.id),s=this.encrypt(t),r=n||this.peerId,i=JSON.stringify(s);this.transport.send(i,r,!0)}},{key:"subscribeInternalEvent",value:function e(){var e=this;this.on("display_uri",function(n){var t=n.showQrCodeModal;t!==!1&&(m.open({cb:function(){e.events.emit("modal_closed",new M(N.CLOSE_MODAL.code,N.CLOSE_MODAL.message))},lng:e.lng}),e.transport.connected?(e.events.emit("uri_ready",e.uri),e.key&&m.ready(e.uri)):e.transport.retryFailed&&m.fail())}),this.on("transport_open",function(n){e.relay=n,e.events.emit("uri_ready",e.uri),e.key&&m.ready(e.uri)}),this.on("transport_error",function(e,n){n?e_(ew(n)):(em(),m.fail())}),this.on("modal_closed",function(){var n="response-".concat(e.handshakeId);e.callbacks.get(n)&&e.callbacks.delete(n),e.clearConnectionStatus()}),this.on("connect",function(){e.pending=!1,m.close()}),this.on("call_request_sent",function(){D()}),this.on("wc_sessionUpdate",function(n,t){if(n){e.handleSessionResponse();return}t.params&&Array.isArray(t.params)?e.handleSessionResponse(t.params[0]):t.error&&e.handleSessionResponse()})}},{key:"subscribeToSessionResponse",value:function e(e){var n=this;this.callbacks.set("response-".concat(e),function(e,t){if(e){n.handleSessionResponse();return}t&&(t.result?n.handleSessionResponse(t.result):t.error&&t.error.message?n.handleSessionResponse():n.handleSessionResponse())})}},{key:"handleSessionResponse",value:function e(e){e?e.approved?(this._connected?(e.chainId&&this.setChainId(e.chainId),e.accounts&&this.setAddress(e.accounts)):(this._connected=!0,e.chainId&&this.setChainId(e.chainId),e.accounts&&this.setAddress(e.accounts),e.peerId&&!this.peerId&&(this.peerId=e.peerId),e.peerMeta&&!this.peerMeta&&(this.peerMeta=e.peerMeta),this.events.emit("connect",{chainId:this.chainId,accounts:this.accounts})),this.manageStorageSession()):this.connected?this.handleSessionDisconnect(g.DisconnectAtWallet):this.handleRejectSessionConnection(new M(N.REJECT_SESSION.code,N.REJECT_SESSION.message)):this.handleRejectSessionConnection(new M(N.REJECT_SESSION.code,N.REJECT_SESSION.message))}},{key:"handleRejectSessionConnection",value:function e(e){m.close(),this.clearConnectionStatus(),this.events.emit("session_error",e)}},{key:"handleSessionDisconnect",value:function e(e){this._connected||m.close(),this.events.emit("disconnect",e),this.clearConnectionStatus()}},{key:"clearConnectionStatus",value:function e(){this._connected&&(this._connected=!1),this._handshakeId&&(this._handshakeId=0),this._handshakeTopic&&(this._handshakeTopic=""),this._peerId&&(this._peerId=""),this._clientId&&(this._clientId=""),this.pending&&(this.pending=!1),this.callbacks.clear(),this._peerMeta=null,this._accounts=[],this._chainId="0x0",this.offConnectEvents(),this.removeStorageSession(),this.transport.close()}},{key:"offConnectEvents",value:function e(){this.removeListener("connect")}},{key:"setChainId",value:function e(e){var n=P(e);if(n==="0x0"){this.chainId=n;return}l(this.chainId)<"u"&&this.chainId!==n&&this.events.emit("chainChanged",n),this.chainId=n}},{key:"setAddress",value:function e(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];var n=e.filter(function(e){return typeof e=="string"}).map(function(e){return e.toLowerCase()}).filter(Boolean);JSON.stringify(this.accounts)!==JSON.stringify(n)&&this.events.emit("accountsChanged",n),this.accounts=n}}]);return a}(Y);export{eS as Core};//# sourceMappingURL=index.js.map