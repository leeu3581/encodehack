function t(t){if(t===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return t}function e(t,e){if(!(t instanceof e)){throw new TypeError("Cannot call a class as a function")}}function n(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(t,r.key,r)}}function r(t,e,r){if(e)n(t.prototype,e);if(r)n(t,r);return t}function o(t){o=Object.setPrototypeOf?Object.getPrototypeOf:function t(t){return t.__proto__||Object.getPrototypeOf(t)};return o(t)}function i(t,e){if(typeof e!=="function"&&e!==null){throw new TypeError("Super expression must either be null or a function")}t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:true,configurable:true}});if(e)u(t,e)}function s(e,n){if(n&&(c(n)==="object"||typeof n==="function")){return n}return t(e)}function u(t,e){u=Object.setPrototypeOf||function t(t,e){t.__proto__=e;return t};return u(t,e)}function c(t){"@swc/helpers - typeof";return t&&typeof Symbol!=="undefined"&&t.constructor===Symbol?"symbol":typeof t}function a(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true}catch(t){return false}}function f(t){var e=a();return function n(){var n=o(t),r;if(e){var i=o(this).constructor;r=Reflect.construct(n,arguments,i)}else{r=n.apply(this,arguments)}return s(this,r)}}var l=Object.defineProperty;var h=function(t,e,n){return e in t?l(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n};var y=function(t,e,n){return h(t,(typeof e==="undefined"?"undefined":c(e))!="symbol"?e+"":e,n),n};import{Events as p}from"@binance/w3w-utils";import k from"ws";var d=(typeof window==="undefined"?"undefined":c(window))<"u"?window.WebSocket:k,v=function(n){"use strict";i(s,n);var o=f(s);function s(n){e(this,s);var r;r=o.call(this);r.opts=n;y(t(r),"qs");y(t(r),"urls",[]);y(t(r),"url");y(t(r),"socket");y(t(r),"nextSocket");y(t(r),"queue",[]);y(t(r),"subscriptions",[]);y(t(r),"retryIndex",0);r.socket=null,r.nextSocket=null,r.subscriptions=n.subscriptions||[],r.qs="env=browser&protocol=wc&version=".concat(n.version);return r}r(s,[{key:"readyState",get:function t(){return this.socket?this.socket.readyState:-1},set:function t(t){}},{key:"connecting",get:function t(){return this.readyState===0},set:function t(t){}},{key:"connected",get:function t(){return this.readyState===1},set:function t(t){}},{key:"retryFailed",get:function t(){return this.retryIndex>0&&this.retryIndex>this.urls.length},set:function t(t){}},{key:"open",value:function t(t){if(!Array.isArray(t)||t.length===0)throw new Error("Missing or invalid WebSocket url");this.urls=t,this.retryIndex=0,this.socketCreate()}},{key:"close",value:function t(){this._socketClose()}},{key:"send",value:function t(t,e,n){if(!e||typeof e!="string")throw new Error("Missing or invalid topic field");this.socketSend({topic:e,type:"pub",payload:t,silent:!!n})}},{key:"subscribe",value:function t(t){this.socketSend({topic:t,type:"sub",payload:"",silent:!0})}},{key:"socketCreate",value:function t(){var t=this;if(this.nextSocket)return;var e=this.url||this.getWsUrl();if(!e)return this.events.emit("error",new Error("Retry limit reached. Can't connect to any url."),e);if(this.url=e,this.nextSocket=new d(e),!this.nextSocket)throw new Error("Failed to create socket");this.nextSocket.onmessage=function(e){return t.socketReceive(e)},this.nextSocket.onopen=function(){return t.socketOpen()},this.nextSocket.onerror=function(n){return t.socketError(n,e)},this.nextSocket.onclose=function(e){t.nextSocket=null,t.socketCreate()}}},{key:"getWsUrl",value:function t(){return this.retryIndex>=this.urls.length?"":"".concat(this.urls[this.retryIndex++],"?").concat(this.qs)}},{key:"socketOpen",value:function t(){this._socketClose(),this.socket=this.nextSocket,this.nextSocket=null,this.queueSubscriptions(),this.pushQueue(),this.events.emit("open",this.urls[this.retryIndex-1])}},{key:"_socketClose",value:function t(){this.socket&&(this.socket.onclose=function(){},this.socket.close(),this.events.emit("close"))}},{key:"socketSend",value:function t(t){var e=JSON.stringify(t);this.socket&&this.socket.readyState===1?this.socket.send(e):this.setToQueue(t)}},{key:"socketReceive",value:function t(t){var e;try{e=JSON.parse(t.data)}catch(t){return}this.socketSend({topic:e.topic,type:"ack",payload:"",silent:!0}),this.socket&&this.socket.readyState===1&&this.events.emit("message",e)}},{key:"socketError",value:function t(t,e){this.events.emit("error",t,e)}},{key:"queueSubscriptions",value:function t(){var t=this;this.subscriptions.forEach(function(e){return t.queue.push({topic:e,type:"sub",payload:"",silent:!0})}),this.subscriptions=this.opts.subscriptions||[]}},{key:"setToQueue",value:function t(t){this.queue.push(t)}},{key:"pushQueue",value:function t(){var t=this;this.queue.forEach(function(e){return t.socketSend(e)}),this.queue=[]}}]);return s}(p);function b(t){var e=Date.now();return new Promise(function(n){try{setTimeout(function(){n({ttl:0,url:t})},5e3);var r=new d(t);r.onopen=function(){r.close(),n({ttl:Date.now()-e,url:t})},r.onerror=function(){n({ttl:0,url:t})}}catch(e){n({ttl:0,url:t})}})}export{v as SocketTransport,b as detectWebSocket};//# sourceMappingURL=index.js.map